<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.trechina.planocycle.mapper.WorkPriorityOrderPtsClassify">
    <insert id="setWorkPtsClassify">
        insert into priority.work_priority_order_pts_classify(company_cd,priority_order_cd,pts_cd,sku_num,pts_branch_num,sku_num_init,
        <foreach collection="colNameList" separator="," item="item">
            ${item}
        </foreach>
        )
        select #{companyCd},#{priorityOrderCd}, pts_cd, count(DISTINCT jandata.jan) as sku_num ,count(DISTINCT branch) as branch_num,count(DISTINCT jandata.jan) as sku_num,

        <foreach collection="colNameList" item="item" separator=",">
            mst.${item}
        </foreach>
        from
        planocycle.shelf_pts_data_jandata jandata
        left join priority.work_priority_order_result_data mst
        on mst.jan_old = jandata.jan
        INNER join planocycle.shelf_pts_data ptsdata
        on jandata.pts_cd = ptsdata."id"
        INNER join planocycle.shelf_pattern_branch branch
        on branch.shelf_pattern_cd = ptsdata.shelf_pattern_cd
        where jandata.pts_cd in
        <foreach collection="shelfPtsData" item="item" separator="," open="(" index="index" close=")">
            #{item.id}
        </foreach>
        GROUP BY pts_cd,
        <foreach collection="colNameList" item="item" separator=",">
            mst.${item}
        </foreach>

    </insert>
    <delete id="deleteWork">
        delete from priority.work_priority_order_pts_classify where company_cd = #{companyCd} and priority_order_cd = #{priorityOrderCd}
    </delete>
    <select id="getJanPtsCd" resultType="integer">
        select pts_cd
        from priority.work_priority_order_pts_classify
        where sku_num_init >=${map.rank_upd}
        and priority_order_cd = #{priorityOrderCd}
        and
        <foreach collection="map" separator="and" item="item" index="index" >
            <if test="index == 'attr1' || index == 'attr2' || index == 'attr3' || index == 'attr4' || index == 'attr5' || index == 'attr6' || index == 'attr7' || index == 'attr8' || index == 'attr9' || index == 'mulit_attr'">
                ${index} = #{item}
            </if>
        </foreach>
        GROUP BY pts_cd
    </select>
    <select id="getJanBranchNum" resultType="java.lang.Integer">
        SELECT count(DISTINCT branch)as branch_num_upd
        from planocycle.shelf_pts_data ptsdata
        left join planocycle.shelf_pattern_branch branch
        on ptsdata.shelf_pattern_cd = branch.shelf_pattern_cd
        where id in
        <foreach collection="ptsCd" item="item" separator="," open="(" close=")" >
            #{item}
        </foreach>
    </select>
</mapper>